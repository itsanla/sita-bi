// packages/db/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

//================================================================================
//  ENUMS
//================================================================================

enum Prodi {
  D3
  D4
}

enum StatusTugasAkhir {
  DRAFT
  DIAJUKAN
  DISETUJUI
  BIMBINGAN
  REVISI
  MENUNGGU_PEMBATALAN
  DIBATALKAN
  LULUS_TANPA_REVISI
  LULUS_DENGAN_REVISI
  SELESAI
  DITOLAK
  GAGAL
}

enum PengajuanStatus {
  MENUNGGU_PERSETUJUAN_DOSEN
  MENUNGGU_PERSETUJUAN_MAHASISWA
  DIBATALKAN_MAHASISWA
  DIBATALKAN_DOSEN
  DITOLAK
  DISETUJUI
  KEDALUWARSA
}

enum PeranDosen {
  pembimbing1
  pembimbing2
  penguji1
  penguji2
  penguji3
}

enum JenisSidang {
  PROPOSAL
  AKHIR
}

enum StatusVerifikasi {
  menunggu_verifikasi
  disetujui
  ditolak
  berkas_tidak_lengkap
}

enum StatusPersetujuan {
  menunggu
  disetujui
  ditolak
}

enum HasilSidang {
  menunggu_penjadwalan
  dijadwalkan
  lulus
  lulus_revisi
  tidak_lulus
}

enum StatusBimbingan {
  dijadwalkan
  ditolak
  selesai
  berjalan
  diajukan
  dibatalkan
}

enum AudiensPengumuman {
  guest
  registered_users
  all_users
  dosen
  mahasiswa
}

enum TipeDokumenBimbingan {
  bimbingan
}

enum TipeDokumenSidang {
  NASKAH_TA
  TOEIC
  RAPOR
  IJAZAH_SLTA
  BEBAS_JURUSAN
}

enum LogLevel {
  INFO
  WARN
  ERROR
  DEBUG
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
}

enum PrioritasPengumuman {
  RENDAH
  MENENGAH
  TINGGI
}

enum KategoriPengumuman {
  AKADEMIK
  ADMINISTRASI
  KEMAHASISWAAN
  LAINNYA
}

//================================================================================
//  MODEL INTI (User, Roles, Dosen, Mahasiswa)
//================================================================================

/// Model User merepresentasikan entitas login utama.
model User {
  id                    Int       @id @default(autoincrement())
  name                  String
  email                 String    @unique
  phone_number          String    @unique
  email_verified_at     DateTime?
  password              String
  photo                 String?
  alamat                String?
  tanggal_lahir         DateTime?
  tempat_lahir          String?
  jenis_kelamin         String?
  remember_token        String?
  failed_login_attempts Int       @default(0)
  lockout_until         DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  // Relasi Profil & Hak Akses
  mahasiswa Mahasiswa? // Profil jika user adalah mahasiswa
  dosen     Dosen? // Profil jika user adalah dosen
  roles     Role[] // Peran yang dimiliki user

  // Relasi Kepemilikan Data
  logs                        Log[]
  pengumumanDibuat            Pengumuman[]
  tawaranTopikDibuat          TawaranTopik[]
  taDisetujui                 TugasAkhir[]                    @relation("Approver")
  taDitolak                   TugasAkhir[]                    @relation("Rejecter")
  notifikasi                  NotifikasiTA[]
  notificationHistory         NotificationHistory[]
  emailTokens                 EmailVerificationToken[]
  catatanBimbingan            CatatanBimbingan[]
  historyPenugasan            HistoryPenugasanDosen[]         @relation("AdminAssigner")
  historyPerubahanSidang      HistoryPerubahanSidang[]
  pengumumanDibaca            PengumumanPembaca[]
  pengajuanPelepasanBimbingan PengajuanPelepasanBimbingan[]
  periodeTaBuka               PeriodeTa[]                     @relation("PeriodePembuka")
  periodeTaTutup              PeriodeTa[]                     @relation("PeriodePenutup")

  @@map("users")
}

/// Model Role untuk implementasi hak akses seperti Spatie.
model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  guard_name  String       @default("api")
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt
  users       User[]
  permissions Permission[]

  @@map("roles")
}

model Permission {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  guard_name String   @default("api")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  roles      Role[]

  @@map("permissions")
}

/// Profil khusus untuk Mahasiswa, berisi data akademik.
model Mahasiswa {
  id         Int      @id @default(autoincrement())
  user_id    Int      @unique
  nim        String   @unique
  prodi      Prodi
  kelas      String
  ipk        Float?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relasi
  user                   User                     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  tugasAkhir             TugasAkhir?
  historyTopik           HistoryTopikMahasiswa[]
  historyPerubahanJadwal HistoryPerubahanJadwal[]
  PengajuanBimbingan     PengajuanBimbingan[]

  @@map("mahasiswa")
}

/// Profil khusus untuk Dosen, berisi data akademik.
model Dosen {
  id              Int      @id @default(autoincrement())
  user_id         Int      @unique
  nip             String   @unique
  prodi           Prodi?   // Prodi untuk kaprodi D3/D4
  level_hierarki  String?  // "jurusan" | "kaprodi" | "dosen_biasa"
  kuota_bimbingan Int      @default(4)
  bidang_keahlian String?
  jabatan         String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relasi
  user                  User                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  peranDosenTa          PeranDosenTa[]
  bimbingan             BimbinganTA[]
  nilaiSidang           NilaiSidang[]
  dokumenValidasiP1     DokumenTa[]             @relation("ValidatorP1")
  dokumenValidasiP2     DokumenTa[]             @relation("ValidatorP2")
  PengajuanBimbingan    PengajuanBimbingan[]
  historyPenugasanDosen HistoryPenugasanDosen[]

  @@map("dosen")
}

//================================================================================
//  MODEL TUGAS AKHIR & ALURNYA
//================================================================================

model TawaranTopik {
  id             Int       @id @default(autoincrement())
  user_id        Int
  periode_ta_id  Int?
  judul_topik    String
  deskripsi      String
  kuota          Int
  deleted_at     DateTime?
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  dosenPencetus User                    @relation(fields: [user_id], references: [id])
  periodeTa     PeriodeTa?              @relation(fields: [periode_ta_id], references: [id])
  historyTopik  HistoryTopikMahasiswa[]
  tugasAkhir    TugasAkhir[]

  @@map("tawaran_topik")
}

model HistoryTopikMahasiswa {
  id               Int      @id @default(autoincrement())
  mahasiswa_id     Int
  tawaran_topik_id Int
  status           String
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  mahasiswa    Mahasiswa    @relation(fields: [mahasiswa_id], references: [id])
  tawaranTopik TawaranTopik @relation(fields: [tawaran_topik_id], references: [id])

  @@map("history_topik_mahasiswa")
}

model TugasAkhir {
  id                   Int              @id @default(autoincrement())
  mahasiswa_id         Int              @unique
  tawaran_topik_id     Int?
  periode_ta_id        Int?
  judul                String
  judul_divalidasi_p1  Boolean          @default(false)
  judul_divalidasi_p2  Boolean          @default(false)
  status               StatusTugasAkhir @default(DRAFT)
  tanggal_pengajuan    DateTime?
  disetujui_oleh       Int?
  ditolak_oleh         Int?
  alasan_penolakan     String?
  created_at           DateTime         @default(now())
  updated_at           DateTime         @updatedAt

  mahasiswa             Mahasiswa               @relation(fields: [mahasiswa_id], references: [id])
  tawaranTopik          TawaranTopik?           @relation(fields: [tawaran_topik_id], references: [id])
  periodeTa             PeriodeTa?              @relation(fields: [periode_ta_id], references: [id])
  approver              User?                   @relation("Approver", fields: [disetujui_oleh], references: [id])
  rejecter              User?                   @relation("Rejecter", fields: [ditolak_oleh], references: [id])
  peranDosenTa          PeranDosenTa[]
  bimbinganTa           BimbinganTA[]
  dokumenTa             DokumenTa[]
  sidang                Sidang[]
  pendaftaranSidang     PendaftaranSidang[]
  notifikasi            NotifikasiTA[]
  historyPenugasanDosen HistoryPenugasanDosen[]

  @@map("tugas_akhir")
}

model PeranDosenTa {
  id             Int        @id @default(autoincrement())
  tugas_akhir_id Int
  dosen_id       Int
  peran          PeranDosen
  created_at     DateTime   @default(now())
  updated_at     DateTime   @updatedAt

  tugasAkhir                 TugasAkhir                      @relation(fields: [tugas_akhir_id], references: [id], onDelete: Cascade)
  dosen                      Dosen                           @relation(fields: [dosen_id], references: [id])
  pengajuanPelepasanBimbingan PengajuanPelepasanBimbingan[]

  @@unique([tugas_akhir_id, peran])
  @@map("peran_dosen_ta")
}

//================================================================================
//  MODEL BIMBINGAN
//================================================================================

model BimbinganTA {
  id                Int             @id @default(autoincrement())
  tugas_akhir_id    Int
  dosen_id          Int
  peran             String
  sesi_ke           Int
  tanggal_bimbingan DateTime?
  jam_bimbingan     String?
  jam_selesai       String?
  status_bimbingan  StatusBimbingan @default(dijadwalkan)
  is_konfirmasi     Boolean         @default(false)
  konfirmasi_at     DateTime?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt

  tugasAkhir       TugasAkhir               @relation(fields: [tugas_akhir_id], references: [id], onDelete: Cascade)
  dosen            Dosen                    @relation(fields: [dosen_id], references: [id])
  catatan          CatatanBimbingan[]
  lampiran         BimbinganLampiran[]
  historyPerubahan HistoryPerubahanJadwal[]

  @@map("bimbingan_ta")
}

model BimbinganLampiran {
  id              Int      @id @default(autoincrement())
  bimbingan_ta_id Int
  file_path       String
  file_name       String?
  file_type       String?
  created_at      DateTime @default(now())

  bimbinganTa BimbinganTA @relation(fields: [bimbingan_ta_id], references: [id], onDelete: Cascade)

  @@map("bimbingan_lampiran")
}

model CatatanBimbingan {
  id              Int      @id @default(autoincrement())
  bimbingan_ta_id Int
  author_id       Int
  catatan         String
  author_type     String // "Mahasiswa" atau "Dosen"
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  bimbinganTa BimbinganTA @relation(fields: [bimbingan_ta_id], references: [id], onDelete: Cascade)
  author      User        @relation(fields: [author_id], references: [id])

  @@map("catatan_bimbingan")
}

model HistoryPerubahanJadwal {
  id               Int       @id @default(autoincrement())
  bimbingan_ta_id  Int
  mahasiswa_id     Int
  tanggal_lama     DateTime?
  jam_lama         String?
  tanggal_baru     DateTime?
  jam_baru         String?
  alasan_perubahan String?
  status           String
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  bimbingan BimbinganTA @relation(fields: [bimbingan_ta_id], references: [id], onDelete: Cascade)
  mahasiswa Mahasiswa   @relation(fields: [mahasiswa_id], references: [id])

  @@map("history_perubahan_jadwal")
}

model PengajuanBimbingan {
  id                  Int             @id @default(autoincrement())
  mahasiswa_id        Int
  dosen_id            Int
  periode_ta_id       Int?
  diinisiasi_oleh     String
  peran_yang_diajukan String // "pembimbing1" atau "pembimbing2"
  status              PengajuanStatus @default(MENUNGGU_PERSETUJUAN_DOSEN)
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt

  mahasiswa Mahasiswa @relation(fields: [mahasiswa_id], references: [id], onDelete: Cascade)
  dosen     Dosen     @relation(fields: [dosen_id], references: [id], onDelete: Cascade)
  periodeTa PeriodeTa? @relation(fields: [periode_ta_id], references: [id])

  @@unique([mahasiswa_id, dosen_id, peran_yang_diajukan])
  @@map("pengajuan_bimbingan")
}

enum StatusPelepasanBimbingan {
  MENUNGGU_KONFIRMASI
  DISETUJUI
  DITOLAK
}

model PengajuanPelepasanBimbingan {
  id                      Int                       @id @default(autoincrement())
  peran_dosen_ta_id       Int
  diajukan_oleh_user_id   Int
  status                  StatusPelepasanBimbingan  @default(MENUNGGU_KONFIRMASI)
  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @updatedAt

  peranDosenTa  PeranDosenTa @relation(fields: [peran_dosen_ta_id], references: [id], onDelete: Cascade)
  diajukanOleh  User         @relation(fields: [diajukan_oleh_user_id], references: [id])

  @@map("pengajuan_pelepasan_bimbingan")
}

//================================================================================
//  MODEL SIDANG & PENDAFTARAN
//================================================================================

model PendaftaranSidang {
  id                   Int               @id @default(autoincrement())
  tugas_akhir_id       Int
  periode_ta_id        Int?
  status_verifikasi    StatusVerifikasi  @default(menunggu_verifikasi)
  status_pembimbing_1  StatusPersetujuan @default(menunggu)
  status_pembimbing_2  StatusPersetujuan @default(menunggu)
  catatan_admin        String?
  catatan_pembimbing_1 String?
  catatan_pembimbing_2 String?
  created_at           DateTime          @default(now())
  updated_at           DateTime          @updatedAt

  tugasAkhir TugasAkhir              @relation(fields: [tugas_akhir_id], references: [id])
  periodeTa  PeriodeTa?              @relation(fields: [periode_ta_id], references: [id])
  sidang     Sidang?
  files      PendaftaranSidangFile[]

  @@map("pendaftaran_sidang")
}

model PendaftaranSidangFile {
  id                    Int               @id @default(autoincrement())
  pendaftaran_sidang_id Int
  file_path             String
  original_name         String
  tipe_dokumen          TipeDokumenSidang
  created_at            DateTime          @default(now())

  pendaftaran PendaftaranSidang @relation(fields: [pendaftaran_sidang_id], references: [id], onDelete: Cascade)

  @@map("pendaftaran_sidang_files")
}

model Sidang {
  id                    Int         @id @default(autoincrement())
  tugas_akhir_id        Int
  pendaftaran_sidang_id Int?        @unique
  periode_ta_id         Int?
  jenis_sidang          JenisSidang
  status_hasil          HasilSidang @default(menunggu_penjadwalan)
  is_active             Boolean     @default(true)
  deleted_at            DateTime?
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt

  tugasAkhir        TugasAkhir               @relation(fields: [tugas_akhir_id], references: [id])
  pendaftaranSidang PendaftaranSidang?       @relation(fields: [pendaftaran_sidang_id], references: [id])
  periodeTa         PeriodeTa?               @relation(fields: [periode_ta_id], references: [id])
  jadwalSidang      JadwalSidang[]
  nilaiSidang       NilaiSidang[]
  historyPerubahan  HistoryPerubahanSidang[]

  @@map("sidang")
}

model HistoryPerubahanSidang {
  id               Int      @id @default(autoincrement())
  sidang_id        Int
  user_id          Int?
  perubahan        String // JSON string or text description
  alasan_perubahan String
  created_at       DateTime @default(now())

  sidang Sidang @relation(fields: [sidang_id], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [user_id], references: [id])

  @@map("history_perubahan_sidang")
}

model JadwalSidang {
  id            Int      @id @default(autoincrement())
  sidang_id     Int
  tanggal       DateTime
  waktu_mulai   String
  waktu_selesai String
  ruangan_id    Int
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  sidang  Sidang  @relation(fields: [sidang_id], references: [id], onDelete: Cascade)
  ruangan Ruangan @relation(fields: [ruangan_id], references: [id])

  @@map("jadwal_sidang")
}

model Ruangan {
  id           Int      @id @default(autoincrement())
  nama_ruangan String
  lokasi       String?
  kapasitas    Int?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  jadwalSidang JadwalSidang[]

  @@map("ruangan")
}

model NilaiSidang {
  id         Int      @id @default(autoincrement())
  sidang_id  Int
  dosen_id   Int
  aspek      String
  komentar   String?
  skor       Float
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  sidang Sidang @relation(fields: [sidang_id], references: [id], onDelete: Cascade)
  dosen  Dosen  @relation(fields: [dosen_id], references: [id])

  @@map("nilai_sidang")
}

//================================================================================
//  MODEL UTILITAS (Dokumen, Log, dll)
//================================================================================

model DokumenTa {
  id                 Int                  @id @default(autoincrement())
  tugas_akhir_id     Int
  tipe_dokumen       TipeDokumenBimbingan
  status_validasi    String               @default("menunggu")
  divalidasi_oleh_p1 Int?
  divalidasi_oleh_p2 Int?
  file_path          String
  version            Int
  deleted_at         DateTime?
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt

  tugasAkhir  TugasAkhir @relation(fields: [tugas_akhir_id], references: [id], onDelete: Cascade)
  validatorP1 Dosen?     @relation("ValidatorP1", fields: [divalidasi_oleh_p1], references: [id])
  validatorP2 Dosen?     @relation("ValidatorP2", fields: [divalidasi_oleh_p2], references: [id])

  @@map("dokumen_ta")
}

model Pengumuman {
  id             Int                 @id @default(autoincrement())
  judul          String
  isi            String
  dibuat_oleh    Int
  audiens        AudiensPengumuman
  is_published   Boolean             @default(false)
  scheduled_at   DateTime?
  prioritas      PrioritasPengumuman @default(MENENGAH)
  kategori       KategoriPengumuman?
  berakhir_pada  DateTime?
  tanggal_dibuat DateTime
  deleted_at     DateTime?
  created_at     DateTime            @default(now())
  updated_at     DateTime            @updatedAt

  pembuat  User                 @relation(fields: [dibuat_oleh], references: [id])
  lampiran PengumumanLampiran[]
  pembaca  PengumumanPembaca[]

  @@map("pengumuman")
}

model PengumumanLampiran {
  id            Int      @id @default(autoincrement())
  pengumuman_id Int
  file_path     String
  file_name     String?
  file_type     String?
  created_at    DateTime @default(now())

  pengumuman Pengumuman @relation(fields: [pengumuman_id], references: [id], onDelete: Cascade)

  @@map("pengumuman_lampiran")
}

model PengumumanPembaca {
  pengumuman_id Int
  user_id       Int
  read_at       DateTime @default(now())

  pengumuman Pengumuman @relation(fields: [pengumuman_id], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([pengumuman_id, user_id])
  @@map("pengumuman_pembaca")
}

model Log {
  id         Int      @id @default(autoincrement())
  user_id    Int?
  action     String
  ip_address String?
  user_agent String?
  url        String?
  method     String?
  details    String?
  module     String?
  entity_id  Int?
  level      LogLevel @default(INFO)
  created_at DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id])

  @@map("logs")
}

model EmailVerificationToken {
  email      String   @unique
  token      String   @unique
  created_at DateTime @default(now())

  user User @relation(fields: [email], references: [email])

  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id         Int      @id @default(autoincrement())
  email      String
  token      String   @unique
  created_at DateTime @default(now())

  @@map("password_reset_tokens")
}

model NotifikasiTA {
  id             Int      @id @default(autoincrement())
  user_id        Int
  tugas_akhir_id Int
  pesan          String
  is_read        Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user       User       @relation(fields: [user_id], references: [id])
  tugasAkhir TugasAkhir @relation(fields: [tugas_akhir_id], references: [id])

  @@map("notifikasi_ta")
}

model NotificationHistory {
  id        Int                 @id @default(autoincrement())
  user_id   Int
  channel   NotificationChannel
  recipient String
  subject   String?
  message   String
  status    String
  error     String?
  sent_at   DateTime            @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@map("notification_history")
}

model HistoryPenugasanDosen {
  id             Int      @id @default(autoincrement())
  tugas_akhir_id Int
  admin_id       Int
  dosen_id       Int
  peran          String // "pembimbing1", "penguji1", etc.
  action         String // "ASSIGN", "UNASSIGN", "REPLACE"
  created_at     DateTime @default(now())

  tugasAkhir TugasAkhir @relation(fields: [tugas_akhir_id], references: [id], onDelete: Cascade)
  admin      User       @relation("AdminAssigner", fields: [admin_id], references: [id])
  dosen      Dosen      @relation(fields: [dosen_id], references: [id])

  @@map("history_penugasan_dosen")
}

model PengaturanSistem {
  id                         Int      @id @default(autoincrement())
  key                        String   @unique
  value                      String
  deskripsi                  String?
  created_at                 DateTime @default(now())
  updated_at                 DateTime @updatedAt

  @@map("pengaturan_sistem")
}

enum StatusPeriode {
  PERSIAPAN
  AKTIF
  SELESAI
}

model PeriodeTa {
  id                    Int           @id @default(autoincrement())
  tahun                 Int           @unique
  nama                  String
  tanggal_buka          DateTime?
  tanggal_tutup         DateTime?
  status                StatusPeriode @default(PERSIAPAN)
  pengaturan_snapshot   String?       // JSON
  dibuka_oleh           Int?
  ditutup_oleh          Int?
  catatan_penutupan     String?
  created_at            DateTime      @default(now())
  updated_at            DateTime      @updatedAt

  pembuka               User?         @relation("PeriodePembuka", fields: [dibuka_oleh], references: [id])
  penutup               User?         @relation("PeriodePenutup", fields: [ditutup_oleh], references: [id])
  tugasAkhir            TugasAkhir[]
  tawaranTopik          TawaranTopik[]
  pengajuanBimbingan    PengajuanBimbingan[]
  sidang                Sidang[]
  pendaftaranSidang     PendaftaranSidang[]

  @@map("periode_ta")
}
