'use client';

import { useState, useEffect } from 'react';
import { useAuth } from '@/context/AuthContext';
import { API_BASE_URL } from '@/lib/config';
import { User, Mail, Phone, MapPin, Calendar, Users, Lock } from 'lucide-react';
import { toast } from 'sonner';

export default function DataDiriMahasiswaPage() {
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [savingPassword, setSavingPassword] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone_number: '',
    alamat: '',
    tanggal_lahir: '',
    tempat_lahir: '',
    jenis_kelamin: '',
    ipk: '',
  });
  const [passwordData, setPasswordData] = useState({
    password_lama: '',
    password_baru: '',
    konfirmasi_password: '',
  });

  useEffect(() => {
    fetchDataDiri();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const fetchDataDiri = async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/data-diri`, {
        headers: { 'x-user-id': user?.id?.toString() || '' },
      });
      const data = await response.json();
      if (data.status === 'sukses') {
        setFormData({
          name: data.data.name || '',
          email: data.data.email || '',
          phone_number: data.data.phone_number || '',
          alamat: data.data.alamat || '',
          tanggal_lahir: data.data.tanggal_lahir
            ? new Date(data.data.tanggal_lahir).toISOString().split('T')[0]
            : '',
          tempat_lahir: data.data.tempat_lahir || '',
          jenis_kelamin: data.data.jenis_kelamin || '',
          ipk: data.data.mahasiswa?.ipk?.toString() || '',
        });
      }
    } catch {
      toast.error('Gagal memuat data diri');
    } finally {
      setLoading(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);

    try {
      const payload: Record<string, string | number | null> = {
        name: formData.name,
        phone_number: formData.phone_number,
        alamat: formData.alamat || null,
        tempat_lahir: formData.tempat_lahir || null,
        jenis_kelamin: formData.jenis_kelamin || null,
      };

      if (formData.tanggal_lahir) {
        payload.tanggal_lahir = new Date(formData.tanggal_lahir).toISOString();
      }

      if (formData.ipk) {
        payload.ipk = parseFloat(formData.ipk);
      }

      const response = await fetch(`${API_BASE_URL}/data-diri`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'x-user-id': user?.id?.toString() || '',
        },
        body: JSON.stringify(payload),
      });

      const data = await response.json();
      if (data.status === 'sukses') {
        toast.success('Data diri berhasil diperbarui');
      } else {
        toast.error(data.message || 'Gagal memperbarui data diri');
      }
    } catch {
      toast.error('Terjadi kesalahan saat menyimpan data');
    } finally {
      setSaving(false);
    }
  };

  const handlePasswordSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSavingPassword(true);

    try {
      const response = await fetch(`${API_BASE_URL}/data-diri/password`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'x-user-id': user?.id?.toString() || '',
        },
        body: JSON.stringify(passwordData),
      });

      const data = await response.json();
      if (data.status === 'sukses') {
        toast.success('Password berhasil diubah');
        setPasswordData({
          password_lama: '',
          password_baru: '',
          konfirmasi_password: '',
        });
      } else {
        toast.error(data.message || 'Gagal mengubah password');
      }
    } catch {
      toast.error('Terjadi kesalahan saat mengubah password');
    } finally {
      setSavingPassword(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#7f1d1d]"></div>
      </div>
    );
  }

  return (
    <div className="px-2 py-3 sm:p-4 lg:p-6 space-y-4 sm:space-y-6">
      <div className="bg-white rounded-xl shadow-base border p-6">
        <h1 className="text-2xl font-bold text-gray-700 mb-6">Data Diri</h1>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <User className="inline w-4 h-4 mr-1" />
                Nama Lengkap
              </label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) =>
                  setFormData({ ...formData, name: e.target.value })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <Mail className="inline w-4 h-4 mr-1" />
                Email
              </label>
              <input
                type="email"
                value={formData.email}
                disabled
                className="w-full px-4 py-3 rounded-xl border border-gray-300 bg-gray-50 text-gray-500 cursor-not-allowed"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <Phone className="inline w-4 h-4 mr-1" />
                Nomor HP
              </label>
              <input
                type="text"
                value={formData.phone_number}
                onChange={(e) =>
                  setFormData({ ...formData, phone_number: e.target.value })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <Users className="inline w-4 h-4 mr-1" />
                Jenis Kelamin
              </label>
              <select
                value={formData.jenis_kelamin}
                onChange={(e) =>
                  setFormData({ ...formData, jenis_kelamin: e.target.value })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
              >
                <option value="">Pilih Jenis Kelamin</option>
                <option value="Laki-laki">Laki-laki</option>
                <option value="Perempuan">Perempuan</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <MapPin className="inline w-4 h-4 mr-1" />
                Tempat Lahir
              </label>
              <input
                type="text"
                value={formData.tempat_lahir}
                onChange={(e) =>
                  setFormData({ ...formData, tempat_lahir: e.target.value })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <Calendar className="inline w-4 h-4 mr-1" />
                Tanggal Lahir
              </label>
              <input
                type="date"
                value={formData.tanggal_lahir}
                onChange={(e) =>
                  setFormData({ ...formData, tanggal_lahir: e.target.value })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
              />
            </div>

            <div className="md:col-span-2">
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <MapPin className="inline w-4 h-4 mr-1" />
                Alamat
              </label>
              <textarea
                value={formData.alamat}
                onChange={(e) =>
                  setFormData({ ...formData, alamat: e.target.value })
                }
                rows={3}
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                IPK
              </label>
              <input
                type="number"
                step="0.01"
                min="0"
                max="4"
                value={formData.ipk}
                onChange={(e) =>
                  setFormData({ ...formData, ipk: e.target.value })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
              />
            </div>
          </div>

          <div className="flex justify-end gap-3">
            <button
              type="button"
              onClick={fetchDataDiri}
              className="px-6 py-3 rounded-xl border-2 border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition-all"
            >
              Batal
            </button>
            <button
              type="submit"
              disabled={saving}
              className="px-6 py-3 rounded-xl bg-[#7f1d1d] text-white font-semibold hover:bg-[#991b1b] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {saving ? 'Menyimpan...' : 'Simpan'}
            </button>
          </div>
        </form>
      </div>

      <div className="bg-white rounded-xl shadow-base border p-6">
        <h2 className="text-xl font-bold text-gray-700 mb-6">Ubah Password</h2>

        <form onSubmit={handlePasswordSubmit} className="space-y-6">
          <div className="grid grid-cols-1 gap-6">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <Lock className="inline w-4 h-4 mr-1" />
                Password Lama
              </label>
              <input
                type="password"
                value={passwordData.password_lama}
                onChange={(e) =>
                  setPasswordData({
                    ...passwordData,
                    password_lama: e.target.value,
                  })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <Lock className="inline w-4 h-4 mr-1" />
                Password Baru
              </label>
              <input
                type="password"
                value={passwordData.password_baru}
                onChange={(e) =>
                  setPasswordData({
                    ...passwordData,
                    password_baru: e.target.value,
                  })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
                required
                minLength={8}
              />
              <p className="text-xs text-gray-500 mt-1">Minimal 8 karakter</p>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                <Lock className="inline w-4 h-4 mr-1" />
                Konfirmasi Password Baru
              </label>
              <input
                type="password"
                value={passwordData.konfirmasi_password}
                onChange={(e) =>
                  setPasswordData({
                    ...passwordData,
                    konfirmasi_password: e.target.value,
                  })
                }
                className="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#7f1d1d] focus:ring-4 focus:ring-[#7f1d1d]/10 outline-none transition-all"
                required
              />
            </div>
          </div>

          <div className="flex justify-end gap-3">
            <button
              type="button"
              onClick={() =>
                setPasswordData({
                  password_lama: '',
                  password_baru: '',
                  konfirmasi_password: '',
                })
              }
              className="px-6 py-3 rounded-xl border-2 border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition-all"
            >
              Batal
            </button>
            <button
              type="submit"
              disabled={savingPassword}
              className="px-6 py-3 rounded-xl bg-[#7f1d1d] text-white font-semibold hover:bg-[#991b1b] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {savingPassword ? 'Menyimpan...' : 'Ubah Password'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
